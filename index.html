<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministry OS | Mission Control</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@16.14.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- React Beautiful DnD -->
    <script src="https://unpkg.com/react-beautiful-dnd@13/umd/react-beautiful-dnd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-main': '#050505', 
                        'bg-panel': '#0A0A0A',
                        'bg-card': '#111111',
                        'border-dim': '#222222',
                        'border-light': '#333333',
                        'accent': '#CCFF00', 
                        'accent-dim': 'rgba(204, 255, 0, 0.1)',
                        'danger': '#ef4444',
                        'danger-dim': 'rgba(239, 68, 68, 0.1)',
                        'strategic': '#8B5CF6', 
                        'text-primary': '#EDEDED', 
                        'text-secondary': '#888888',
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(204, 255, 0, 0.1)',
                        'glow-red': '0 0 20px rgba(239, 68, 68, 0.15)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #050505; color: #EDEDED; font-family: 'Inter', sans-serif; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #222; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .cmd-enter { animation: slideDown 0.15s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const ReactBeautifulDndGlobal = window.ReactBeautifulDnd || window.ReactBeautifulDnD;
        const DragDropFallback = ({ children }) => children;
        const DroppableFallback = ({ children }) =>
            children({ innerRef: () => {}, droppableProps: {}, placeholder: null });
        const DraggableFallback = ({ children }) =>
            children({ innerRef: () => {}, draggableProps: {}, dragHandleProps: {} });
        const { DragDropContext, Droppable, Draggable } = ReactBeautifulDndGlobal || {
            DragDropContext: DragDropFallback,
            Droppable: DroppableFallback,
            Draggable: DraggableFallback,
        };

        // --- ICONS ---
        const Icon = ({ path, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const Icons = {
            Board: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            List: <g><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></g>,
            Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></g>,
            Timeline: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="8" y1="3" x2="8" y2="21" /><line x1="12" y1="8" x2="16" y2="8" /><line x1="12" y1="16" x2="20" y2="16" /></g>,
            Search: <g><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></g>,
            Plus: <g><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></g>,
            Filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />,
            More: <g><circle cx="12" cy="12" r="1" /><circle cx="12" cy="5" r="1" /><circle cx="12" cy="19" r="1" /></g>,
            Check: <polyline points="20 6 9 17 4 12" />,
            Clock: <g><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></g>,
            User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            X: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
            Play: <polygon points="5 3 19 12 5 21 5 3" />,
            Pause: <g><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></g>,
            Focus: <circle cx="12" cy="12" r="10" />,
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            FileText: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></g>,
            Briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></g>,
            Alert: <g><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></g>,
            Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></g>,
            Folder: <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />,
            Grid: <g><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></g>,
            TrendUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />,
            Edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></g>,
            Trash: <g><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></g>,
            Link: <g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g>,
        };

        // --- CONSTANTS ---
        const STORAGE_KEY = 'ministry_os_dashboard_v24'; 
        const ViewType = { BOARD: 'BOARD', PROJECT_LIST: 'PROJECT_LIST', PROJECT_DETAIL: 'PROJECT_DETAIL', GOALS: 'GOALS', MEETING: 'MEETING', FOCUS: 'FOCUS' };
        
        const Status = {
            TODO: { id: 'TODO', label: 'Not Started', color: 'bg-zinc-800 border-zinc-700 text-zinc-400' },
            WAITING: { id: 'WAITING', label: 'Waiting on Others', color: 'bg-orange-900/30 border-orange-800 text-orange-400' },
            BLOCKED: { id: 'BLOCKED', label: 'Blocked', color: 'bg-red-900/30 border-red-800 text-red-400' },
            IN_PROGRESS: { id: 'IN_PROGRESS', label: 'In Motion', color: 'bg-yellow-900/30 border-yellow-800 text-yellow-400' },
            DONE: { id: 'DONE', label: 'Completed', color: 'bg-green-900/30 border-green-800 text-green-400' },
        };

        const Priority = {
            LOW: { id: 'LOW', label: 'Low', color: 'text-zinc-400' },
            MEDIUM: { id: 'MEDIUM', label: 'Medium', color: 'text-blue-400' },
            HIGH: { id: 'HIGH', label: 'High', color: 'text-orange-400' },
            CRITICAL: { id: 'CRITICAL', label: 'Critical', color: 'text-red-500 font-bold' },
        };

        const Assignees = {
            JP: { initials: 'JP', color: 'bg-blue-500' },
            'Bri/Joy': { initials: 'BJ', color: 'bg-green-500' },
            Amanda: { initials: 'A', color: 'bg-purple-500' },
        };

        const InitialProjects = {
            YC26: { id: 'YC26', label: 'Youth Councils 2026', color: '#3B82F6', desc: 'Develop and Execute Youth Councils Brief and Plan. Lead the charge on planning pieces, vision, promotion, and special guests.', archived: false },
            RENDEZVOUS: { id: 'RENDEZVOUS', label: 'Rendezvous', color: '#EC4899', desc: 'Monthly youth gathering coordination and planning.', archived: false },
            DISCIPLESHIP: { id: 'DISCIPLESHIP', label: 'Discipleship & Camp', color: '#10B981', desc: 'Tracking, resource creation, and summer camp spiritual development.', archived: false },
            LEADERSHIP: { id: 'LEADERSHIP', label: 'Leadership', color: '#8B5CF6', desc: 'Internal committee formation and leadership development.', archived: false },
            ADMIN: { id: 'ADMIN', label: 'Administration', color: '#52525B', desc: 'General department upkeep, compliance, and HR goals.', archived: false }
        };

        const generateTasks = () => [
            // YC26 TASKS
            { id: 'OP1', title: 'Worship Band', project: 'YC26', isGoal: false, status: 'WAITING', priority: 'HIGH', assignee: 'JP', due: '2025-11-30', description: 'Waiting on Spark. TWC rejected by Tony.', est: '60m', log: [], subtasks: [], links: [] },
            { id: 'OP2', title: 'Swag', project: 'YC26', isGoal: false, status: 'BLOCKED', priority: 'MEDIUM', assignee: 'JP', due: '2025-12-01', description: 'Blocked: Internal Team Alignment Needed.', est: '120m', log: [], subtasks: [], links: [] },
            { id: 'OP3', title: 'Decor', project: 'YC26', isGoal: false, status: 'IN_PROGRESS', priority: 'MEDIUM', assignee: 'Bri/Joy', due: '2026-01-01', description: 'Delegated to Bri & Joy.', est: '180m', log: [], subtasks: [], links: [] },
            { id: 'OP4', title: 'Friday Night Afterglow', project: 'YC26', isGoal: false, status: 'WAITING', priority: 'LOW', assignee: 'Amanda', due: '2026-01-15', description: 'On hold until after Kettles.', est: '45m', log: [], subtasks: [], links: [] },
            { id: 'G4', title: 'Youth Councils Guests 2026', project: 'YC26', isGoal: true, status: 'DONE', priority: 'CRITICAL', assignee: 'JP', due: '2025-11-07', description: 'Contract received Nov 18.', est: 'DONE', log: [], subtasks: [], links: [] },
            { id: 'G5', title: 'Youth Councils Planning 2027', project: 'YC26', isGoal: true, status: 'TODO', priority: 'LOW', assignee: 'JP', due: '2026-04-30', description: 'Vision and promotion.', est: '120m', log: [], subtasks: [], links: [] },
            { id: 'G6', title: 'Youth Councils Brief 2026', project: 'YC26', isGoal: true, status: 'TODO', priority: 'HIGH', assignee: 'JP', due: '2025-12-19', description: 'Develop Brief and Plan.', est: '240m', log: [], subtasks: [], links: [] },
            
            // OTHER TASKS
            { id: 'G1', title: 'Database Upkeep', project: 'ADMIN', isGoal: true, status: 'IN_PROGRESS', priority: 'MEDIUM', assignee: 'JP', due: 'Ongoing', description: 'Manage Corps Cadets.', est: '30m', log: [], subtasks: [], links: [] },
            { id: 'OP6', title: '2026 Locations', project: 'RENDEZVOUS', isGoal: false, status: 'WAITING', priority: 'HIGH', assignee: 'JP', due: '2025-12-01', description: 'Waiting on Aurora, Blue Island.', est: '60m', log: [], subtasks: [], links: [] },
            { id: 'G14', title: 'Discipleship Frame', project: 'DISCIPLESHIP', isGoal: true, status: 'DONE', priority: 'HIGH', assignee: 'JP', due: '2026-11-07', description: 'Develop discipleship model.', est: 'DONE', log: [], subtasks: [], links: [] },
        ];

        const eventTemplate = [
            {text: "Create registration in Campbrain (10 weeks out)", completed: false},
            {text: "Email field info (10 weeks out)", completed: false},
            {text: "Organize Binder (1 week out)", completed: false},
            {text: "Print Name Tags", completed: false},
            {text: "Prepare Swag", completed: false},
            {text: "Communicate Final Numbers to Camp (2 weeks out)", completed: false}
        ];

        // --- COMPONENTS ---

        const Sidebar = ({ view, setView }) => (
            <div className="w-16 h-full border-r border-border-dim bg-bg-panel flex flex-col items-center py-6 z-20 shrink-0 no-print">
                <div className="w-10 h-10 rounded-xl bg-accent text-black flex items-center justify-center font-display font-bold text-xl mb-8 shadow-glow cursor-pointer hover:scale-105 transition-transform">M</div>
                <div className="flex flex-col gap-4 w-full px-2">
                    <div onClick={() => setView(ViewType.PROJECT_LIST)} className={`w-full aspect-square rounded-lg flex items-center justify-center cursor-pointer transition-colors ${(view === ViewType.PROJECT_LIST || view === ViewType.PROJECT_DETAIL) ? 'bg-zinc-800 text-white' : 'text-text-secondary hover:text-white hover:bg-zinc-800'}`} title="Projects"><Icon path={Icons.Folder} size={20} /></div>
                    <div onClick={() => setView(ViewType.BOARD)} className={`w-full aspect-square rounded-lg flex items-center justify-center cursor-pointer transition-colors ${view === ViewType.BOARD ? 'bg-zinc-800 text-white' : 'text-text-secondary hover:text-white hover:bg-zinc-800'}`} title="All Tasks"><Icon path={Icons.Board} size={20} /></div>
                    <div onClick={() => setView(ViewType.GOALS)} className={`w-full aspect-square rounded-lg flex items-center justify-center cursor-pointer transition-colors ${view === ViewType.GOALS ? 'bg-zinc-800 text-white' : 'text-text-secondary hover:text-white hover:bg-zinc-800'}`} title="Performance Goals"><Icon path={Icons.Shield} size={20} /></div>
                    <div onClick={() => setView(ViewType.MEETING)} className={`w-full aspect-square rounded-lg flex items-center justify-center cursor-pointer transition-colors ${view === ViewType.MEETING ? 'bg-zinc-800 text-white' : 'text-text-secondary hover:text-white hover:bg-zinc-800'}`} title="Meeting Prep"><Icon path={Icons.Briefcase} size={20} /></div>
                    <div onClick={() => setView(ViewType.FOCUS)} className={`w-full aspect-square rounded-lg flex items-center justify-center cursor-pointer transition-colors ${view === ViewType.FOCUS ? 'bg-accent text-black' : 'text-text-secondary hover:text-white hover:bg-zinc-800'}`} title="Focus Mode"><Icon path={Icons.Focus} size={20} /></div>
                </div>
            </div>
        );

        // --- PROJECT COMMAND CENTER ---
        const ProjectDetailView = ({ projectId, tasks, projects, onEdit, onViewBoard, onViewGoals, setView, onGenerateEvent, updateStatus }) => {
            const project = projects[projectId];
            if (!project) return <div>Project not found</div>;
            const pTasks = tasks.filter(t => t.project === projectId);
            const completed = pTasks.filter(t => t.status === 'DONE').length;
            const progress = pTasks.length > 0 ? Math.round((completed / pTasks.length) * 100) : 0;
            
            const attentionTasks = pTasks.filter(t => t.status === 'BLOCKED' || t.status === 'WAITING' || t.priority === 'CRITICAL');
            const [attentionOpen, setAttentionOpen] = useState(true);
            
            const now = new Date();
            const thirtyDays = new Date();
            thirtyDays.setDate(now.getDate() + 30);
            
            const tactical = pTasks.filter(t => t.status !== 'DONE' && t.due && new Date(t.due) <= thirtyDays && !attentionTasks.includes(t));
            const strategic = pTasks.filter(t => t.status !== 'DONE' && t.due && new Date(t.due) > thirtyDays && !attentionTasks.includes(t));
            const others = pTasks.filter(t => t.status !== 'DONE' && !t.due && !attentionTasks.includes(t));

            return (
                <div className="h-full p-8 overflow-y-auto custom-scrollbar">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-8 border-b border-border-dim pb-6">
                        <div>
                            <h1 className="text-4xl font-display font-bold text-white uppercase tracking-tight flex items-center gap-3">
                                {project.label} <span className="text-sm text-text-secondary font-mono bg-zinc-900 px-2 py-1 rounded border border-border-dim tracking-normal">COMMAND CENTER</span>
                            </h1>
                            <div className="flex gap-4 mt-2 text-xs font-mono text-text-secondary">
                                <span className="flex items-center gap-1"><div className={`w-2 h-2 rounded-full`} style={{background: project.color}}></div> Active Project</span>
                                <span className="flex items-center gap-1"><Icon path={Icons.List} size={12}/> {completed} / {pTasks.length} Tasks</span>
                            </div>
                            <div className="flex gap-4 mt-4 text-xs text-accent">
                                <button onClick={() => setView(ViewType.BOARD)} className="hover:underline">View All Tasks in Board</button>
                                <button onClick={() => setView(ViewType.GOALS)} className="hover:underline">View Related Goals</button>
                            </div>
                        </div>
                        
                        <div className="text-right">
                            <div className="text-3xl font-bold font-display text-white">{progress}%</div>
                            <div className="text-[10px] text-text-secondary uppercase tracking-widest">Completion</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-12 gap-8">
                        {/* LEFT COL */}
                        <div className="col-span-4 space-y-6">
                            {/* Briefing */}
                            <div className="bg-bg-card border border-border-dim rounded-xl p-5">
                                <div className="flex items-center gap-2 text-accent font-bold uppercase text-xs tracking-wider mb-3">
                                    <Icon path={Icons.FileText} size={14}/> The Briefing
                                </div>
                                <p className="text-sm text-text-secondary leading-relaxed">{project.desc}</p>
                            </div>

                            {/* Attention Required */}
                            <div className="bg-red-900/5 border border-red-900/30 rounded-xl p-5">
                                <div className="flex items-center justify-between gap-2 text-danger font-bold uppercase text-xs tracking-wider mb-4 cursor-pointer" onClick={() => setAttentionOpen(!attentionOpen)}>
                                    <div className="flex items-center gap-2">
                                        <Icon path={Icons.Alert} size={14}/> Attention Required
                                    </div>
                                    <Icon path={Icons.ChevronDown} size={14} className={`transition-transform ${attentionOpen ? '' : 'rotate-180'}`}/>
                                </div>
                                {attentionOpen && (
                                    <div className="space-y-3">
                                        {attentionTasks.length > 0 ? attentionTasks.map(t => (
                                            <div key={t.id} className="bg-bg-main border border-red-900/30 p-3 rounded hover:border-red-500/50 transition-colors group relative">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-white font-bold text-sm group-hover:text-red-400 transition-colors cursor-pointer" onClick={() => onEdit(t)}>{t.title}</span>
                                                    <button onClick={() => onEdit(t)} className="text-[9px] bg-red-900 text-white px-2 py-1 rounded font-bold hover:bg-red-800 transition-colors">QUICK EDIT</button>
                                                </div>
                                                <div className="text-[10px] font-mono text-red-300/70 mb-2">{t.due}</div>
                                                <div className="text-[10px] text-red-300/50 italic">{t.description}</div>
                                            </div>
                                        )) : <div className="text-zinc-500 text-xs italic">No critical alerts.</div>}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* RIGHT COL */}
                        <div className="col-span-8 bg-bg-card border border-border-dim rounded-xl p-6">
                            <div className="flex items-center justify-between mb-6 border-b border-border-dim pb-4">
                                <div className="flex items-center gap-2 text-white font-bold uppercase text-xs tracking-wider">
                                    <Icon path={Icons.TrendUp} size={14} className="text-strategic"/> Phase Breakdown
                                </div>
                                <div className="flex gap-2">
                                    {project.id === 'RENDEZVOUS' && (
                                        <button onClick={onGenerateEvent} className="bg-white text-black px-4 py-2 rounded font-bold text-xs uppercase hover:bg-accent transition-colors flex items-center gap-2">
                                            <Icon path={Icons.Plus} size={16}/> Generate Event
                                        </button>
                                    )}
                                    <button onClick={() => onEdit({ id: `NEW_${Date.now()}`, project: projectId, status: 'TODO', priority: 'MEDIUM', subtasks: [], links: [], assignee: 'JP' })} className="bg-accent text-black px-4 py-2 rounded font-bold text-xs uppercase flex items-center gap-2">
                                        <Icon path={Icons.Plus} size={16}/> Add Task
                                    </button>
                                </div>
                            </div>

                            <BoardView tasks={pTasks} projects={projects} onEdit={onEdit} updateStatus={updateStatus} isMini={true} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- PROJECT LIST VIEW ---
        const ProjectListView = ({ projects, onViewDetail, onAddProject, onArchiveProject, onUnarchiveProject }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newProjectName, setNewProjectName] = useState('');

            const activeProjects = Object.values(projects).filter(p => !p.archived);
            const archivedProjects = Object.values(projects).filter(p => p.archived);

            const handleAdd = () => {
                if(newProjectName.trim()) {
                    onAddProject(newProjectName);
                    setNewProjectName('');
                    setIsAdding(false);
                }
            };

            return (
                <div className="h-full p-8 overflow-y-auto custom-scrollbar">
                    <div className="flex justify-between items-center mb-8">
                         <h1 className="text-3xl font-display font-bold text-white uppercase tracking-tight">Active Operations</h1>
                         <button onClick={() => setIsAdding(true)} className="bg-white text-black px-4 py-2 rounded font-bold text-xs uppercase hover:bg-accent transition-colors flex items-center gap-2">
                            <Icon path={Icons.Plus} size={16}/> New Project
                        </button>
                    </div>
                   
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {activeProjects.map(p => (
                            <div key={p.id} className="relative bg-bg-card border border-border-dim rounded-xl p-6 cursor-pointer hover:border-white/20 hover:shadow-glow transition-all group hover:-translate-y-1" onClick={() => onViewDetail(p.id)}>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onArchiveProject(p.id); }}
                                    className="absolute top-4 right-4 text-zinc-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <Icon path={Icons.Trash} size={14}/>
                                </button>
                                <div className="flex justify-between items-start mb-4">
                                    <div className="w-10 h-10 rounded bg-zinc-900 flex items-center justify-center text-lg border border-border-dim">
                                        <div className="w-3 h-3 rounded-full" style={{background: p.color}}></div>
                                    </div>
                                </div>
                                <h2 className="text-xl font-display font-bold text-white mb-2">{p.label}</h2>
                                <p className="text-sm text-zinc-500 line-clamp-2">{p.desc || 'No description.'}</p>
                            </div>
                        ))}
                        {isAdding && (
                            <div className="bg-bg-card border border-accent rounded-xl p-6 flex flex-col justify-center">
                                <input 
                                    autoFocus
                                    className="bg-zinc-900 border border-border-dim rounded p-2 text-white mb-2 outline-none" 
                                    placeholder="Project Name" 
                                    value={newProjectName} 
                                    onChange={e => setNewProjectName(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleAdd()}
                                />
                                <div className="flex gap-2">
                                    <button onClick={handleAdd} className="bg-accent text-black px-3 py-1 rounded text-xs font-bold">Create</button>
                                    <button onClick={() => setIsAdding(false)} className="text-zinc-500 px-3 py-1 rounded text-xs">Cancel</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {archivedProjects.length > 0 && (
                        <div className="mt-12">
                            <h2 className="text-2xl font-display font-bold text-white mb-6">Archived Projects</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {archivedProjects.map(p => (
                                    <div key={p.id} className="bg-bg-card border border-border-dim rounded-xl p-6 opacity-50 hover:opacity-100 transition-opacity">
                                        <h3 className="text-lg font-bold text-white mb-2">{p.label}</h3>
                                        <button onClick={() => onUnarchiveProject(p.id)} className="text-accent text-xs hover:underline">Unarchive</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- GOALS VIEW ---
        const GoalsView = ({ tasks, projects, onEdit, updateStatus }) => {
            const goals = tasks.filter(t => t.isGoal);
            return (
                <div className="h-full p-8 overflow-y-auto custom-scrollbar">
                    <h1 className="text-2xl font-display font-bold text-white mb-6">Performance Goals</h1>
                    <div className="bg-bg-card border border-border-dim rounded-xl overflow-hidden">
                        <table className="w-full text-left border-collapse text-xs">
                            <thead className="bg-bg-panel text-text-secondary uppercase font-mono"><tr><th className="p-4 border-b border-border-dim">Goal</th><th className="p-4 border-b border-border-dim">Linked Project</th><th className="p-4 border-b border-border-dim">Deadline</th><th className="p-4 border-b border-border-dim">Status</th></tr></thead>
                            <tbody>
                                {goals.map(t => (
                                    <tr key={t.id} onClick={() => onEdit(t)} className="border-b border-border-dim hover:bg-zinc-900/50 cursor-pointer text-white">
                                        <td className="p-4 font-medium">{t.title}</td>
                                        <td className="p-4"><span className="text-[10px] text-text-secondary font-mono border border-border-dim px-1.5 py-0.5 rounded">{projects[t.project]?.label || t.project}</span></td>
                                        <td className="p-4 font-mono text-accent">{t.due}</td>
                                        <td className="p-4"><span className={`px-2 py-1 rounded border ${Status[t.status].color}`}>{Status[t.status].label}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MEETING PREP VIEW ---
        const MeetingView = ({ tasks }) => {
            const [wins, setWins] = useState(''); const [priorities, setPriorities] = useState(''); const [concerns, setConcerns] = useState(''); const [support, setSupport] = useState(''); const [questions, setQuestions] = useState('');
            useEffect(() => {
                setWins(tasks.filter(t=>t.status==='DONE').map(t=>`• ${t.title}`).join('\n') || '• No completions.');
                setPriorities(tasks.filter(t=>t.status==='IN_PROGRESS').map(t=>`• ${t.title}`).join('\n') || '• Review deadlines.');
                setConcerns(tasks.filter(t=>t.status==='BLOCKED').map(t=>`• ${t.title}: ${t.description}`).join('\n') || '• None.');
                setSupport(tasks.filter(t=>t.status==='WAITING').map(t=>`• ${t.title}: Waiting on ${t.description}`).join('\n') || '• None.');
            }, [tasks]);
            const generatePDF = () => { 
                if (typeof window.jspdf === 'undefined') { alert("PDF Engine Loading..."); return; }
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                
                doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text("1:1 Meeting Agenda", 15, 20);
                doc.setFontSize(10); doc.setFont("helvetica","normal"); doc.text(new Date().toLocaleDateString(), 180, 20);
                let y = 35;
                
                const drawRow = (title, content, color) => {
                    const startY = y;
                    const col1Width = 45; 
                    const col2Width = 150; 
                    const col2X = 15 + col1Width;
                    
                    doc.setFont("helvetica", "bold"); doc.setFontSize(11);
                    const titleLines = doc.splitTextToSize(title, col1Width - 4);
                    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
                    const contentLines = doc.splitTextToSize(content, col2Width - 4);
                    
                    const height = Math.max(titleLines.length * 6, contentLines.length * 6) + 10;
                    
                    if (y + height > 280) { doc.addPage(); y = 15; }

                    doc.setDrawColor(200); doc.setLineWidth(0.1);
                    doc.rect(15, y, col1Width, height); doc.rect(col2X, y, col2Width, height);
                    
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont("helvetica", "bold");
                    doc.text(titleLines, 17, y + 8);
                    
                    doc.setTextColor(0);
                    doc.setFont("helvetica", "normal");
                    doc.text(contentLines, col2X + 2, y + 8);
                    
                    y += height;
                };
                
                drawRow("Wins From Last Week", wins, [22,163,74]); 
                drawRow("Priorities", priorities, [37,99,235]); 
                drawRow("Concerns", concerns, [220,38,38]); 
                drawRow("Support Needed", support, [234,88,12]);
                drawRow("Questions and Feedback", questions, [0,0,0]);

                y += 10;
                doc.setFont("helvetica", "bold");
                doc.text("Any Questions or Feedback For Me:", 15, y);
                doc.line(15, y+5, 195, y+5);

                doc.save("Meeting_Agenda.pdf");
            };
            
            return (
                <div className="h-full p-8 overflow-y-auto custom-scrollbar">
                    <div className="flex justify-between mb-8"><h1 className="text-3xl font-display font-bold text-white">Agenda Builder</h1><button onClick={generatePDF} className="bg-white text-black px-4 py-2 rounded font-bold text-xs uppercase hover:bg-accent flex items-center gap-2"><Icon path={Icons.Download} size={16}/> Export PDF</button></div>
                    <div className="grid grid-cols-[200px_1fr] border border-border-dim rounded bg-bg-card">
                        <div className="p-4 border-r border-b border-border-dim bg-zinc-900/50 text-green-500 font-bold text-xs uppercase">Wins</div><textarea className="bg-transparent text-white p-4 text-sm border-b border-border-dim resize-none h-24 outline-none" value={wins} onChange={e=>setWins(e.target.value)}/>
                        <div className="p-4 border-r border-b border-border-dim bg-zinc-900/50 text-blue-500 font-bold text-xs uppercase">Priorities</div><textarea className="bg-transparent text-white p-4 text-sm border-b border-border-dim resize-none h-24 outline-none" value={priorities} onChange={e=>setPriorities(e.target.value)}/>
                        <div className="p-4 border-r border-b border-border-dim bg-zinc-900/50 text-red-500 font-bold text-xs uppercase">Concerns</div><textarea className="bg-transparent text-white p-4 text-sm border-b border-border-dim resize-none h-24 outline-none" value={concerns} onChange={e=>setConcerns(e.target.value)}/>
                        <div className="p-4 border-r border-border-dim bg-zinc-900/50 text-orange-500 font-bold text-xs uppercase">Support</div><textarea className="bg-transparent text-white p-4 text-sm resize-none h-24 outline-none" value={support} onChange={e=>setSupport(e.target.value)}/>
                    </div>
                </div>
            );
        };

        // --- BOARD VIEW ---
        const BoardView = ({ tasks, onEdit, projects, updateStatus, isMini = false }) => {
            const onDragEnd = (result) => {
                const { source, destination, draggableId } = result;
                if (!destination || source.droppableId === destination.droppableId) return;
                updateStatus(draggableId, destination.droppableId);
            };

            return (
                <DragDropContext onDragEnd={onDragEnd}>
                    <div className={`flex ${isMini ? 'overflow-x-auto gap-4' : 'h-full overflow-x-auto p-6 gap-6 custom-scrollbar'}`}>
                        {Object.keys(Status).map(key => {
                            const columnTasks = tasks.filter(t => t.status === key).sort((a, b) => {
                                const aOverdue = a.due && new Date(a.due) < new Date() && a.status !== 'DONE' ? -1 : 0;
                                const bOverdue = b.due && new Date(b.due) < new Date() && b.status !== 'DONE' ? -1 : 0;
                                return aOverdue - bOverdue;
                            });
                            return (
                                <Droppable droppableId={key} key={key}>
                                    {(provided) => (
                                        <div ref={provided.innerRef} {...provided.droppableProps} className="flex-shrink-0 w-80 flex flex-col h-full">
                                            <div className="mb-3 px-1 flex justify-between"><span className="text-xs font-bold text-text-secondary uppercase tracking-widest">{Status[key].label}</span><span className="text-[10px] bg-zinc-900 px-2 py-0.5 rounded text-zinc-500">{columnTasks.length}</span></div>
                                            <div className="flex-1 bg-bg-panel/50 rounded-xl border border-dashed border-border-dim p-2 overflow-y-auto custom-scrollbar">
                                                {columnTasks.map((t, index) => (
                                                    <Draggable draggableId={t.id} index={index} key={t.id}>
                                                        {(provided) => {
                                                            const isOverdue = t.due && new Date(t.due) < new Date() && t.status !== 'DONE';
                                                            const overdueDays = isOverdue ? Math.ceil((new Date() - new Date(t.due)) / (86400000)) : 0;
                                                            const isDone = t.status === 'DONE';
                                                            const subCompleted = t.subtasks.filter(s => s.completed).length;
                                                            const subTotal = t.subtasks.length;
                                                            const subProgress = subTotal > 0 ? (subCompleted / subTotal) * 100 : 0;

                                                            return (
                                                                <div
                                                                    ref={provided.innerRef}
                                                                    {...provided.draggableProps}
                                                                    {...provided.dragHandleProps}
                                                                    className={`bg-bg-card border p-3 rounded mb-2 cursor-pointer hover:border-text-secondary transition-all group ${isOverdue ? 'bg-red-950/40 border-red-600 glow-red' : 'border-border-dim'} ${isDone ? 'opacity-50' : ''}`}
                                                                >
                                                                    {isOverdue && <div className="text-[10px] text-red-400 mb-1 font-bold">Overdue {overdueDays} day{overdueDays > 1 ? 's' : ''}</div>}
                                                                    <div className="flex justify-between mb-2">
                                                                        <span className="text-[10px] text-zinc-500 font-mono">{projects[t.project]?.label || t.project}</span>
                                                                        {t.priority==='CRITICAL' && <span className="text-[9px] text-red-500 font-bold">!!!</span>}
                                                                    </div>
                                                                    <div className="flex items-center gap-2 mb-2">
                                                                        {t.assignee && Assignees[t.assignee] && (
                                                                            <div className={`w-5 h-5 rounded-full ${Assignees[t.assignee].color} flex items-center justify-center text-[8px] text-white`}>
                                                                                {Assignees[t.assignee].initials}
                                                                            </div>
                                                                        )}
                                                                        <span className={`text-sm text-white font-medium ${isDone ? 'line-through' : ''}`}>{t.title}</span>
                                                                    </div>
                                                                    {t.subtasks.length > 0 && (
                                                                        <div className="mt-2">
                                                                            <div className="w-full bg-zinc-800 h-1.5 rounded-full overflow-hidden">
                                                                                <div className="bg-accent h-full" style={{width: `${subProgress}%`}} />
                                                                            </div>
                                                                            <div className="text-[10px] text-zinc-500 mt-1">{subCompleted} / {subTotal}</div>
                                                                        </div>
                                                                    )}
                                                                    {t.links.length > 0 && (
                                                                        <div className="mt-2 flex flex-wrap gap-2">
                                                                            {t.links.map((link, i) => (
                                                                                <a key={i} href={link.url} target="_blank" className="text-[10px] text-blue-400 hover:underline flex items-center gap-1">
                                                                                    <Icon path={Icons.Link} size={10}/> {link.name || 'Link'}
                                                                                </a>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                    <div className="flex gap-1 mt-2 opacity-0 group-hover:opacity-100 transition-opacity text-[10px]">
                                                                        {!isDone && (
                                                                            <>
                                                                                <button onClick={(e) => {e.stopPropagation(); updateStatus(t.id, 'IN_PROGRESS');}} className="px-2 py-0.5 bg-yellow-900/50 rounded hover:bg-yellow-800/50">Start</button>
                                                                                <button onClick={(e) => {e.stopPropagation(); updateStatus(t.id, 'DONE');}} className="px-2 py-0.5 bg-green-900/50 rounded hover:bg-green-800/50">Complete</button>
                                                                                <button onClick={(e) => {e.stopPropagation(); updateStatus(t.id, 'BLOCKED');}} className="px-2 py-0.5 bg-red-900/50 rounded hover:bg-red-800/50">Block</button>
                                                                            </>
                                                                        )}
                                                                        <button onClick={(e) => {e.stopPropagation(); onEdit(t);}} className="px-2 py-0.5 bg-zinc-900/50 rounded hover:bg-zinc-800/50">Edit</button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        }}
                                                    </Draggable>
                                                ))}
                                                {provided.placeholder}
                                            </div>
                                        </div>
                                    )}
                                </Droppable>
                            );
                        })}
                    </div>
                </DragDropContext>
            );
        };

        // --- FOCUS VIEW ---
        const FocusView = ({ tasks, onEdit, updateStatus }) => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const highPriorityTasks = tasks.filter(t => (t.priority === 'HIGH' || t.priority === 'CRITICAL') && t.status !== 'DONE');
            useEffect(() => {
                let interval;
                if (isRunning) interval = setInterval(() => setTime(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, [isRunning]);

            return (
                <div className="h-full p-8 overflow-y-auto custom-scrollbar">
                    <h1 className="text-3xl font-display font-bold text-white mb-6">Focus Mode</h1>
                    <div className="flex items-center gap-4 mb-8">
                        <button onClick={() => setIsRunning(!isRunning)} className="bg-accent text-black px-4 py-2 rounded flex items-center gap-2">
                            {isRunning ? <Icon path={Icons.Pause} size={16}/> : <Icon path={Icons.Play} size={16}/>} {Math.floor(time / 60)}:{time % 60 < 10 ? '0' : ''}{time % 60}
                        </button>
                        <button onClick={() => setTime(0)} className="text-zinc-500 px-4 py-2">Reset</button>
                    </div>
                    <div className="space-y-4">
                        {highPriorityTasks.map(t => {
                            const isOverdue = t.due && new Date(t.due) < new Date();
                            const overdueDays = isOverdue ? Math.ceil((new Date() - new Date(t.due)) / 86400000) : 0;
                            return (
                                <div key={t.id} className={`bg-bg-card p-4 rounded border ${isOverdue ? 'border-danger glow-red' : 'border-border-dim'} hover:border-accent transition-colors`}>
                                    {isOverdue && <div className="text-xs text-danger mb-1">Overdue {overdueDays} days</div>}
                                    <div className="flex justify-between">
                                        <span className="text-white font-medium">{t.title}</span>
                                        <button onClick={() => onEdit(t)} className="text-accent hover:underline">Edit</button>
                                    </div>
                                    <span className="text-xs text-zinc-500">{t.project} • Due: {t.due}</span>
                                    <div className="flex gap-2 mt-2 text-[10px]">
                                        <button onClick={() => updateStatus(t.id, 'IN_PROGRESS')} className="px-2 py-0.5 bg-yellow-900/50 rounded">Start</button>
                                        <button onClick={() => updateStatus(t.id, 'DONE')} className="px-2 py-0.5 bg-green-900/50 rounded">Complete</button>
                                    </div>
                                </div>
                            );
                        })}
                        {highPriorityTasks.length === 0 && <div className="text-zinc-500">No high-priority tasks. Great job!</div>}
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, task, onSave, projects }) => {
            const [data, setData] = useState(task || { subtasks: [], links: [] });
            const [tab, setTab] = useState('DETAILS');
            
            useEffect(() => { if(isOpen) setData({...task, subtasks: task.subtasks || [], links: task.links || []}); }, [isOpen, task]);
            
            if(!isOpen) return null;

            const addSubtask = () => setData({ ...data, subtasks: [...data.subtasks, {text: '', completed: false}] });
            const updateSubtask = (index, field, value) => {
                const newSubtasks = [...data.subtasks];
                newSubtasks[index][field] = value;
                setData({ ...data, subtasks: newSubtasks });
            };
            const removeSubtask = (index) => setData({ ...data, subtasks: data.subtasks.filter((_, i) => i !== index) });

            const addLink = () => setData({ ...data, links: [...data.links, {name: '', url: ''}] });
            const updateLink = (index, field, value) => {
                const newLinks = [...data.links];
                newLinks[index][field] = value;
                setData({ ...data, links: newLinks });
            };
            const removeLink = (index) => setData({ ...data, links: data.links.filter((_, i) => i !== index) });

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-bg-card border border-border-dim w-full max-w-lg rounded-xl shadow-2xl flex flex-col overflow-hidden">
                         <div className="h-14 border-b border-border-dim flex justify-between items-center px-6 bg-bg-panel">
                            <div className="flex gap-4">
                                <button onClick={() => setTab('DETAILS')} className={`text-xs font-bold uppercase tracking-wider px-2 py-1 rounded ${tab === 'DETAILS' ? 'text-black bg-white' : 'text-zinc-500 hover:text-white'}`}>Details</button>
                                <button onClick={() => setTab('LOG')} className={`text-xs font-bold uppercase tracking-wider px-2 py-1 rounded ${tab === 'LOG' ? 'text-white bg-red-600' : 'text-zinc-500 hover:text-red-500'}`}>Paper Trail (CYA)</button>
                            </div>
                            <button onClick={onClose} className="text-zinc-500 hover:text-white"><Icon path={Icons.X} size={18}/></button>
                        </div>
                        <div className="p-6 custom-scrollbar overflow-y-auto flex-1">
                             {tab === 'DETAILS' ? (
                                <>
                                     <input className="w-full bg-transparent text-2xl font-bold text-white mb-4 outline-none" value={data.title||''} onChange={e=>setData({...data, title:e.target.value})} placeholder="Title"/>
                                    <div className="grid grid-cols-3 gap-4 mb-4">
                                         <select className="bg-zinc-900 border border-border-dim text-white p-2 rounded text-xs" value={data.project || ''} onChange={e=>setData({...data, project:e.target.value})}>
                                            {Object.values(projects).map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                                         </select>
                                         <select className="bg-zinc-900 border border-border-dim text-white p-2 rounded text-xs" value={data.status} onChange={e=>setData({...data, status:e.target.value})}>{Object.keys(Status).map(k=><option key={k} value={k}>{Status[k].label}</option>)}</select>
                                         <select className="bg-zinc-900 border border-border-dim text-white p-2 rounded text-xs" value={data.assignee || ''} onChange={e=>setData({...data, assignee:e.target.value})}>
                                             <option value="">Assignee</option>
                                             {Object.keys(Assignees).map(a => <option key={a} value={a}>{a}</option>)}
                                         </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <input type="date" className="bg-zinc-900 border border-border-dim text-white p-2 rounded text-xs" value={data.due || ''} onChange={e=>setData({...data, due:e.target.value})} />
                                        <select className="bg-zinc-900 border border-border-dim text-white p-2 rounded text-xs" value={data.priority || 'MEDIUM'} onChange={e=>setData({...data, priority:e.target.value})}>
                                            {Object.keys(Priority).map(k => <option key={k} value={k}>{Priority[k].label}</option>)}
                                        </select>
                                    </div>
                                    <textarea className="w-full h-32 bg-zinc-900 border border-border-dim p-4 text-sm text-white rounded mb-4" placeholder="Description..." value={data.description||''} onChange={e=>setData({...data, description:e.target.value})}></textarea>
                                    <div className="mb-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="text-sm font-bold text-white">Subtasks</h4>
                                            <button onClick={addSubtask} className="text-accent text-xs hover:underline">Add Subtask</button>
                                        </div>
                                        <div className="space-y-2">
                                            {data.subtasks.map((st, i) => (
                                                <div key={i} className="flex items-center gap-2">
                                                    <input type="checkbox" checked={st.completed} onChange={e => updateSubtask(i, 'completed', e.target.checked)} className="accent-accent" />
                                                    <input 
                                                        className="flex-1 bg-zinc-900 border border-border-dim p-2 text-sm text-white rounded" 
                                                        value={st.text} 
                                                        onChange={e => updateSubtask(i, 'text', e.target.value)} 
                                                        placeholder="Subtask description"
                                                    />
                                                    <button onClick={() => removeSubtask(i)} className="text-danger hover:text-red-300"><Icon path={Icons.Trash} size={14}/></button>
                                                </div>
                                            ))}
                                            {data.subtasks.length === 0 && <div className="text-zinc-500 text-xs">No subtasks yet.</div>}
                                        </div>
                                    </div>
                                    <div className="mb-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="text-sm font-bold text-white">Links / Attachments</h4>
                                            <button onClick={addLink} className="text-accent text-xs hover:underline">Add Link</button>
                                        </div>
                                        <div className="space-y-2">
                                            {data.links.map((link, i) => (
                                                <div key={i} className="flex items-center gap-2">
                                                    <input 
                                                        className="w-1/2 bg-zinc-900 border border-border-dim p-2 text-sm text-white rounded" 
                                                        value={link.name} 
                                                        onChange={e => updateLink(i, 'name', e.target.value)} 
                                                        placeholder="Name"
                                                    />
                                                    <input 
                                                        className="w-1/2 bg-zinc-900 border border-border-dim p-2 text-sm text-white rounded" 
                                                        value={link.url} 
                                                        onChange={e => updateLink(i, 'url', e.target.value)} 
                                                        placeholder="URL"
                                                    />
                                                    <button onClick={() => removeLink(i)} className="text-danger hover:text-red-300"><Icon path={Icons.Trash} size={14}/></button>
                                                </div>
                                            ))}
                                            {data.links.length === 0 && <div className="text-zinc-500 text-xs">No links yet.</div>}
                                        </div>
                                    </div>
                                </>
                             ) : (
                                 <div className="bg-red-900/10 border border-red-900/30 p-4 rounded">
                                    <h3 className="text-red-500 font-bold text-xs uppercase mb-2">Evidence Log</h3>
                                    <textarea className="w-full h-32 bg-zinc-900 border border-border-dim p-4 text-sm text-white rounded mb-4" placeholder="Log interaction details..." value={data.log?.[0]?.note || ''} onChange={e=>{
                                        const newLog = [...(data.log||[])];
                                        if(newLog.length > 0) newLog[0].note = e.target.value;
                                        else newLog.push({date: new Date().toISOString().slice(0,10), note: e.target.value});
                                        setData({...data, log: newLog});
                                    }}></textarea>
                                 </div>
                             )}
                        </div>
                        <div className="flex justify-end gap-2 p-4 border-t border-border-dim"><button onClick={onClose} className="text-zinc-500 px-4 py-2">Cancel</button><button onClick={()=>onSave(data)} className="bg-accent text-black font-bold px-4 py-2 rounded">Save</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState(ViewType.PROJECT_LIST);
            const [activeProject, setActiveProject] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            
            const [projects, setProjects] = useState(() => {
                 const saved = localStorage.getItem(STORAGE_KEY + '_projects');
                 return saved ? JSON.parse(saved) : InitialProjects;
            });

            const [tasks, setTasks] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : generateTasks();
            });
            const [editingTask, setEditingTask] = useState(null);

            useEffect(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem(STORAGE_KEY + '_projects', JSON.stringify(projects)); }, [projects]);

            const filteredTasks = useMemo(() => {
                if (!searchQuery) return tasks;
                const lowerQuery = searchQuery.toLowerCase();
                return tasks.filter(t => 
                    t.title.toLowerCase().includes(lowerQuery) || 
                    t.description?.toLowerCase().includes(lowerQuery) ||
                    t.project.toLowerCase().includes(lowerQuery)
                );
            }, [tasks, searchQuery]);

            const updateStatus = (id, newStatus) => {
                setTasks(prev => prev.map(t => t.id === id ? {...t, status: newStatus} : t));
            };

            const handleSave = (task) => {
                if (task.id && task.id.startsWith('NEW_')) {
                    task.id = `T${Date.now()}`;
                    setTasks(prev => [...prev, task]);
                } else {
                    setTasks(prev => prev.map(t => t.id === task.id ? task : t));
                }
                setEditingTask(null);
            };

            const addProject = (name) => {
                const id = name.toUpperCase().replace(/\s+/g, '');
                const newProj = { id, label: name, color: '#888888', desc: 'New Project', archived: false };
                setProjects(prev => ({ ...prev, [id]: newProj }));
            };

            const archiveProject = (id) => {
                setProjects(prev => ({ ...prev, [id]: { ...prev[id], archived: true } }));
            };

            const unarchiveProject = (id) => {
                setProjects(prev => ({ ...prev, [id]: { ...prev[id], archived: false } }));
            };

            const openProject = (pid) => { setActiveProject(pid); setView(ViewType.PROJECT_DETAIL); };

            const generateEvent = () => {
                const newTask = {
                    id: `NEW_${Date.now()}`,
                    title: `Rendezvous ${new Date().toLocaleDateString()}`,
                    project: 'RENDEZVOUS',
                    status: 'TODO',
                    priority: 'MEDIUM',
                    assignee: 'JP',
                    due: '',
                    description: 'New monthly event',
                    subtasks: eventTemplate.map(s => ({...s})),
                    links: [],
                    log: [],
                    est: '120m',
                    isGoal: false
                };
                handleSave(newTask);
            };

            const exportData = () => {
                const data = { projects, tasks };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ministry_os.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imported = JSON.parse(event.target.result);
                        setProjects(imported.projects);
                        setTasks(imported.tasks);
                    };
                    reader.readAsText(file);
                }
            };

            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'n' && !editingTask) {
                        setEditingTask({ id: `NEW_${Date.now()}`, project: activeProject || 'ADMIN', status: 'TODO', priority: 'MEDIUM', subtasks: [], links: [], assignee: 'JP' });
                    } else if (e.key === '1') {
                        // Quick status TODO, etc. - would need selected task
                    } else if (e.key === '?') {
                        console.log('Shortcuts: n - new task');
                    }
                };
                document.addEventListener('keydown', handleKey);
                return () => document.removeEventListener('keydown', handleKey);
            }, [editingTask, activeProject]);

            const stats = useMemo(() => {
                const open = filteredTasks.filter(t => t.status !== 'DONE').length;
                const overdue = filteredTasks.filter(t => t.due && new Date(t.due) < new Date() && t.status !== 'DONE').length;
                const thisWeekEnd = new Date();
                thisWeekEnd.setDate(thisWeekEnd.getDate() + 7);
                const thisWeek = filteredTasks.filter(t => t.due && new Date(t.due) <= thisWeekEnd && new Date(t.due) >= new Date() && t.status !== 'DONE').length;
                return { open, overdue, thisWeek };
            }, [filteredTasks]);

            return (
                <div className="flex w-screen h-screen bg-bg-main text-text-primary overflow-hidden font-sans">
                    <Sidebar view={view} setView={setView} />
                    <main className="flex-1 flex flex-col relative z-10 overflow-hidden">
                         <div className="h-14 border-b border-border-dim flex items-center px-6 bg-bg-main shrink-0 justify-between">
                            <div className="text-sm font-mono text-text-secondary uppercase tracking-widest">Command Center</div>
                            <div className="flex-1 mx-4">
                                <input 
                                    className="w-full bg-zinc-900 border border-border-dim p-2 rounded text-sm text-white placeholder-zinc-500" 
                                    placeholder="Search tasks..." 
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                />
                            </div>
                            <div className="flex items-center gap-4 text-xs text-zinc-400">
                                <span>Open: {stats.open}</span>
                                <span className={stats.overdue > 0 ? 'text-danger' : ''}>Overdue: {stats.overdue}</span>
                                <span>This Week: {stats.thisWeek}</span>
                                <button onClick={exportData} className="text-accent hover:underline">Export</button>
                                <label className="text-accent hover:underline cursor-pointer">
                                    Import <input type="file" accept=".json" onChange={importData} className="hidden" />
                                </label>
                            </div>
                        </div>

                        <div className="flex-1 overflow-hidden relative bg-bg-main">
                            {view === ViewType.PROJECT_LIST && <ProjectListView projects={projects} onViewDetail={openProject} onAddProject={addProject} onArchiveProject={archiveProject} onUnarchiveProject={unarchiveProject} />}
                            {view === ViewType.PROJECT_DETAIL && activeProject && <ProjectDetailView projectId={activeProject} tasks={filteredTasks} projects={projects} onEdit={setEditingTask} setView={setView} onGenerateEvent={generateEvent} updateStatus={updateStatus} />}
                            {view === ViewType.BOARD && <BoardView tasks={filteredTasks} projects={projects} onEdit={setEditingTask} updateStatus={updateStatus} />}
                            {view === ViewType.GOALS && <GoalsView tasks={filteredTasks} projects={projects} onEdit={setEditingTask} updateStatus={updateStatus} />}
                            {view === ViewType.MEETING && <MeetingView tasks={filteredTasks} />}
                            {view === ViewType.FOCUS && <FocusView tasks={filteredTasks} onEdit={setEditingTask} updateStatus={updateStatus} />}
                        </div>
                    </main>
                    <Modal isOpen={!!editingTask} onClose={() => setEditingTask(null)} task={editingTask} onSave={handleSave} projects={projects} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
